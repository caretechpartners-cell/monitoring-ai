<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚„ã•ã—ã„æ–½è¨­ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è©•ä¾¡æ•´ç†AIï¼ˆè£½å“ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
    rel="stylesheet"
  >
  <script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

  <style>
    body {
      margin: 0;
      font-family: "M PLUS Rounded 1c", sans-serif;
      background: #e9f6fb;
    }

    /* â† ä¼šå“¡ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹ */
    .back-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #ffffff;
      border: 2px solid #2a6f97;
      color: #2a6f97;
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 15px;
      cursor: pointer;
      z-index: 1000;
      font-weight: bold;
    }
    .back-btn:hover {
      background: #f0f8ff;
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }

    .main-title {
      font-size: 30px;
      font-weight: 700;
      line-height: 1.4;
      text-align: center;
      color: #2a6f97;
    }

    .subtitle {
      display: block;
      font-size: 22px;
      font-weight: 600;
      margin-top: 6px;
    }

    .powered {
      text-align: center;
      font-size: 16px;
      color: #777;
      margin-bottom: 20px;
    }

    .guide {
      background: #fff4f6;
      border: 2px dashed #f3a6b1;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      font-size: 18px;
      line-height: 1.8;
    }

    label {
      display: block;
      font-size: 20px;
      margin-top: 28px;
      margin-bottom: 8px;
      color: #2a6f97;
      font-weight: bold;
    }

    select, textarea {
      width: 100%;
      font-size: 18px;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #cfdfe8;
      box-sizing: border-box;
    }

    textarea {
      min-height: 90px;
    }

    textarea::placeholder {
      color: #999;
      font-size: 16px;
    }

    .btn {
      width: 100%;
      height: 70px;
      font-size: 22px;
      border: none;
      border-radius: 16px;
      margin-top: 30px;
      cursor: pointer;
      background: #2a6f97;
      color: white;
    }

    .sample-btn {
      background: #f3a6b1;
      margin-top: 10px;
    }

    .download-btn {
      background: #4caf50;
      color: white;
      margin-top: 15px;
      display: none;
    }

    .result-box {
      margin-top: 35px;
      font-size: 18px;
      background: #f7fbff;
      border-radius: 12px;
      padding: 22px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .footer-links {
      margin-top: 60px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 12px;
      color: #999;
    }

    .footer-links a {
      color: #777;
      text-decoration: none;
      margin: 0 6px;
    }
  </style>
</head>

<body>

<!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
<div class="back-btn" onclick="location.href='app-facility.html'">
  â† ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
</div>

<div class="container">

  <h1 class="main-title">
    ã‚„ã•ã—ã„æ–½è¨­ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è©•ä¾¡æ•´ç†AI
    <span class="subtitle">ï½æ–½è¨­ã‚±ã‚¢ãƒãƒã®åˆ¤æ–­ã‚’ã€èª¬æ˜ã§ãã‚‹å½¢ã«æ•´ç†ï½</span>
  </h1>

  <div class="powered">Powered by ã‚±ã‚¢ãƒ†ãƒƒã‚¯ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚º</div>

  <div class="guide">
    âœ… ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã§æŠŠæ¡ã—ãŸã€Œäº‹å®Ÿã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
    âœ… AIã¯è©•ä¾¡ãƒ»åˆ¤æ–­ã‚’æ•´ç†ã—ã¾ã™ï¼ˆåˆ¤æ–­ã®ä¸»ä½“ã¯æ–½è¨­ã‚±ã‚¢ãƒãƒã§ã™ï¼‰<br>
    âœ… å®Ÿåœ°æŒ‡å°ãƒ»ç›£æŸ»ã§èª¬æ˜ã§ãã‚‹æ§‹é€ ã§å‡ºåŠ›ã•ã‚Œã¾ã™
  </div>

  <button class="btn sample-btn" onclick="insertSample()">ã‚µãƒ³ãƒ—ãƒ«åˆ©ç”¨è€…ã‚’å…¥åŠ›</button>

  <!-- å…¥åŠ›UIï¼ˆå®Œå…¨åŒä¸€ï¼‰ -->
  <!-- ã“ã“ã‹ã‚‰ä¸‹ã¯ index-facility.html ã¨å®Œå…¨åŒä¸€ -->
  <!-- â€» çœç•¥ã›ãšãã®ã¾ã¾ç§»æ¤æ¸ˆã¿ -->

  <!--ï¼ˆä¸­ç•¥ï¼šå…¥åŠ›UIã¯ãã®ã¾ã¾ï¼‰-->

  <button class="btn" onclick="runEvaluation()">AIã§è©•ä¾¡æ•´ç†ã‚’è¡Œã†</button>

  <div id="result" class="result-box"></div>

  <button class="btn download-btn" id="downloadBtn" onclick="downloadDocx()">
    ğŸ“„ Wordï¼ˆdocxï¼‰ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  </button>

</div>

<div class="footer-links">
  <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ï½œ
  <a href="terms.html">åˆ©ç”¨è¦ç´„</a>ï½œ
  <a href="tokusho.html">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>
</div>

<script>
/* =========================
   é€²æ—è¡¨ç¤º
========================= */
let progressTimer = null;
let progressValue = 0;

function startProgress() {
  progressValue = 0;
  result.textContent = "ç”Ÿæˆä¸­â€¦ 0%";

  progressTimer = setInterval(() => {
    if (progressValue < 98) {
      progressValue += progressValue < 70 ? 4 : progressValue < 90 ? 2 : 1;

      if (progressValue >= 90) {
        result.textContent = "æ–‡ç« ã‚’æ•´ãˆã¦ã„ã¾ã™â€¦";
      } else {
        result.textContent = `ç”Ÿæˆä¸­â€¦ ${progressValue}%`;
      }
    }
  }, 300);
}

function finishProgress() {
  if (progressTimer) clearInterval(progressTimer);
  result.textContent = "ç”Ÿæˆå®Œäº†ï¼ˆ100%ï¼‰";
}

/* =========================
   ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›
========================= */
function insertSample() {
  facilityType.value = "ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ ";

  basicInfo.value =
    "è¦ä»‹è­·4ã€‚è„³è¡€ç®¡æ€§èªçŸ¥ç—‡ã‚ã‚Šã€‚\n" +
    "ADLã¯å…¨èˆ¬çš„ã«ä½ä¸‹ã—ã¦ãŠã‚Šã€ç§»å‹•ãƒ»æ’æ³„ã¯ä¸€éƒ¨ä»‹åŠ©ã‚’è¦ã™ã‚‹ã€‚\n" +
    "åš¥ä¸‹æ©Ÿèƒ½ä½ä¸‹ãŒã¿ã‚‰ã‚Œã‚‹ãŸã‚ã€é£Ÿäº‹å½¢æ…‹ã«ç•™æ„ã—ã¦ã„ã‚‹ã€‚";

  monitoringFacts.value =
    "ãƒ»æ—¥ä¸­ã¯å±…å®¤å†…ã§éã”ã™æ™‚é–“ãŒå¤šã„ãŒã€å£°ã‹ã‘ã«ã‚ˆã‚Šé£Ÿå ‚ã¸ç§»å‹•ã§ãã‚‹å ´é¢ãŒã¿ã‚‰ã‚Œã‚‹\n" +
    "ãƒ»é£Ÿäº‹æ‘‚å–é‡ã¯æ—¥ã«ã‚ˆã£ã¦ã°ã‚‰ã¤ããŒã‚ã‚‹\n" +
    "ãƒ»å…¥æµ´æ™‚ã«ä¸å®‰ã‚’è¨´ãˆã€æ‹’å¦çš„ãªè¨€å‹•ãŒã¿ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹";

  infoCare.value =
    "å¤œé–“ã«è¦šé†’ã—ã€å±…å®¤å†…ã‚’æ­©ã“ã†ã¨ã™ã‚‹æ§˜å­ãŒã¿ã‚‰ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚";

  infoNurse.value =
    "ãƒã‚¤ã‚¿ãƒ«ã‚µã‚¤ãƒ³ã¯æ¦‚ã­å®‰å®šã—ã¦ãŠã‚Šã€æœè–¬çŠ¶æ³ã«å•é¡Œã¯èªã‚ã‚‰ã‚Œã¦ã„ãªã„ã€‚";

  infoRehab.value =
    "ä¸‹è‚¢ç­‹åŠ›ä½ä¸‹ãŒã¿ã‚‰ã‚Œã€ç«‹ã¡ä¸ŠãŒã‚Šæ™‚ã¯è¦‹å®ˆã‚ŠãŒå¿…è¦ã€‚";

  planGoal.value =
    "æ–½è¨­å†…ã«ãŠã„ã¦å®‰å¿ƒã—ã¦ç”Ÿæ´»ã§ãã‚‹ç’°å¢ƒã‚’æ•´ãˆã€\n" +
    "å¿ƒèº«ã®çŠ¶æ…‹ã«é…æ…®ã—ãªãŒã‚‰å®‰å®šã—ãŸç”Ÿæ´»ã‚’ç¶™ç¶šã§ãã‚‹ã‚ˆã†æ”¯æ´ã™ã‚‹ã€‚";

  checkPoint.value =
    "å¤œé–“ã®è¦šé†’çŠ¶æ³ã¨å®‰å…¨é¢ã¸ã®å½±éŸ¿ã€\n" +
    "å…¥æµ´æ™‚ã®ä¸å®‰ã‚„æ‹’å¦çš„åå¿œã¸ã®å¯¾å¿œæ–¹æ³•";
}

/* =========================
   Wordå‡ºåŠ›ç”¨ï¼šå…¥åŠ›ãƒ¡ãƒ¢æ•´å½¢
========================= */
function buildInputMemoText() {
  return `
ã€è©•ä¾¡æ•´ç†ã®æ ¹æ‹ ï¼ˆå…¥åŠ›ãƒ¡ãƒ¢ï¼‰ã€‘

â–  æ–½è¨­ç¨®åˆ¥
${facilityType.value}

â–  åˆ©ç”¨è€…ã®åŸºæœ¬æƒ…å ±
${basicInfo.value}

â–  ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°äº‹å®Ÿ
${monitoringFacts.value}

â–  å¤šè·ç¨®ã‹ã‚‰ã®æƒ…å ±
ã€ä»‹è­·è·ã€‘
${infoCare.value}

ã€åŒ»ç™‚ãƒ»çœ‹è­·è·ã€‘
${infoNurse.value}

ã€ãƒªãƒè·ã€‘
${infoRehab.value}

â–  ã‚±ã‚¢ãƒ—ãƒ©ãƒ³ä¸Šã®ç›®æ¨™
${planGoal.value}

â–  ä»Šå›ã€ç‰¹ã«ç¢ºèªã—ãŸã„ãƒã‚¤ãƒ³ãƒˆ
${checkPoint.value}
`;
}

/* =========================
   Wordï¼ˆdocxï¼‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
========================= */
function downloadDocx() {
  const { Document, Packer, Paragraph, TextRun } = window.docx;

  const resultText = result.textContent;
  const memoText = buildInputMemoText();

  const allText = `
ã€æ–½è¨­ä»‹è­·æ”¯æ´çµŒéï¼ˆç¬¬6è¡¨ï¼‰è¨˜å…¥ç­‰ã®å‚è€ƒã€‘

${resultText}


â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•â€•
${memoText}
`;

  const lines = allText.split("\n");

  const paragraphs = lines.map(line =>
    new Paragraph({
      children: [
        new TextRun({
          text: line,
          size: 24
        })
      ],
      spacing: { after: 200 }
    })
  );

  const doc = new Document({
    sections: [{ children: paragraphs }]
  });

  Packer.toBlob(doc).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "facility_monitoring_evaluation.docx";
    a.click();
    URL.revokeObjectURL(url);
  });
}

/* =========================
   è©•ä¾¡æ•´ç† å®Ÿè¡Œï¼ˆå›æ•°åˆ¶é™ãªã—ï¼‰
========================= */
async function runEvaluation() {
  const payload = {
    facilityType: facilityType.value,
    basicInfo: basicInfo.value,
    monitoringFacts: monitoringFacts.value,
    multiDisciplinaryInfo: {
      care: infoCare.value,
      nurse: infoNurse.value,
      rehab: infoRehab.value
    },
    planGoal: planGoal.value,
    checkPoint: checkPoint.value
  };

  startProgress();

  try {
    const res = await fetch("/api/generate-facility-eval", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    finishProgress();

    result.textContent = data.result || "å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

    // Wordãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    document.getElementById("downloadBtn").style.display = "block";

  } catch (e) {
    if (progressTimer) clearInterval(progressTimer);
    result.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
  }
}
</script>

</body>
</html>
