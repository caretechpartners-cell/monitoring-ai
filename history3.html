<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç”Ÿæˆå±¥æ­´ï½œæ–½è¨­ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è©•ä¾¡æ•´ç†AI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/docx@8.5.0/build/index.umd.js"></script>

<style>
body {
  margin: 0;
  font-family: "M PLUS Rounded 1c", sans-serif;
  background: #e9f6fb;
}
.container {
  max-width: 900px;
  margin: 40px auto;
  background: #ffffff;
  border-radius: 20px;
  padding: 30px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #2a6f97;
  font-size: 28px;
  margin-bottom: 30px;
}
.history-card {
  background: #f7fbff;
  border-radius: 12px;
  margin-bottom: 25px;
  cursor: pointer;
  position: relative;
  padding-left: 26px;
}
.history-card::before {
  content: "";
  position: absolute;
  left: 10px;
  top: 14px;
  bottom: 14px;
  width: 12px;
  border-left: 4px solid #2a6f97;
  border-top: 4px solid #2a6f97;
  border-bottom: 4px solid #2a6f97;
  border-radius: 12px;
}
.history-header {
  padding: 20px;
}
.date {
  color: #2a6f97;
  font-weight: bold;
}
.history-body {
  padding: 0 20px 20px;
  display: none;
}
.item-label {
  font-weight: bold;
  margin-top: 12px;
}
.back-fixed {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 18px;
  border-radius: 12px;
  background: #ccc;
  border: none;
  cursor: pointer;
}
</style>
</head>

<body>

<button class="back-fixed" onclick="location.href='app-facility.html'">â† ä¼šå“¡ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>

<div class="container">
<h1>ç”Ÿæˆå±¥æ­´ä¸€è¦§</h1>
<div id="historyArea">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
</div>

<script>
async function loadHistory() {

  const area = document.getElementById("historyArea");
  const authUserId = localStorage.getItem("auth_user_id");
  if (!authUserId) {
    location.href = "login.html";
    return;
  }

  const res = await fetch("/api/history", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "get",
      type: "facility",
      auth_user_id: localStorage.getItem("auth_user_id")
    })
  });

  const result = await res.json();
  if (!result.success || result.data.length === 0) {
    area.innerHTML = "ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  let html = "";
  result.data.forEach((row, index) => {

    const formatted = (row.generated_text || "").replace(/\n/g, "<br>");

    html += `
    <div class="history-card" onclick="toggleCard(${index})">
      <div class="history-header">
        <div class="date">ğŸ“… ${new Date(row.created_at).toLocaleString("ja-JP")}</div>
      </div>

      <div class="history-body" id="body-${index}">
        <div class="item"><div class="item-label">â–  æ–½è¨­å</div>${row.facility_name || ""}</div>
        <div class="item"><div class="item-label">â–  åˆ©ç”¨è€…å</div>${row.resident_name || ""}</div>
        <div class="item"><div class="item-label">â–  ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°å ´é¢</div>${row.monitoring_scene || ""}</div>
        <div class="item"><div class="item-label">â–  è¦³å¯Ÿå†…å®¹</div>${row.observation || ""}</div>
        <div class="item"><div class="item-label">â–  ç‰¹è¨˜äº‹é …</div>${row.special_notes || ""}</div>

<div class="item">
  <div class="item-label">â–  ç”Ÿæˆçµæœ</div>
  <div id="generated-${index}">${formatted}</div>

  <button
    style="margin-top:12px;padding:8px 14px;border-radius:8px;border:none;background:#2a6f97;color:#fff;cursor:pointer;"
    onclick="downloadWord(event, ${index})"
  >
    ğŸ“„ Wordã§ä¿å­˜
  </button>
</div>
      </div>
    </div>`;
  });

  area.innerHTML = html;
}

function toggleCard(i) {
  const el = document.getElementById(`body-${i}`);
  el.style.display = el.style.display === "block" ? "none" : "block";
}

loadHistory();

function downloadWord(event, index) {
  event.stopPropagation(); // ã‚«ãƒ¼ãƒ‰é–‹é–‰ã‚’é˜²ã

  const text = document.getElementById(`generated-${index}`).innerText;

  const { Document, Packer, Paragraph } = window.docx;

  const doc = new Document({
    sections: [
      {
        children: text.split("\n").map(line =>
          new Paragraph({ text: line })
        )
      }
    ]
  });

  Packer.toBlob(doc).then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "æ–½è¨­ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è©•ä¾¡æ•´ç†.docx";
    a.click();
    URL.revokeObjectURL(url);
  });
}

</script>

</body>
</html>
