// ================================
// 施設モニタリング 評価整理AI
// /api/generate-facility-eval.js
// ================================

import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ error: "Method not allowed" });
  }

  try {
    const {
      facilityType,
      basicInfo,
      monitoringFacts,
      multiDisciplinaryInfo,
      planGoal,
      checkPoint,
    } = req.body;

    // 最低限のバリデーション
    if (!facilityType || !monitoringFacts) {
      return res.status(400).json({
        error: "必要な情報が不足しています",
      });
    }

const prompt = `
あなたは「介護保険施設における計画担当介護支援専門員（施設ケアマネ）」の業務を支援するAIです。
あなたの役割は【判断を下すこと】ではありません。

施設ケアマネが行ったモニタリング結果をもとに、
【評価・考察の整理】と【説明可能な文章化】を行ってください。

━━━━━━━━━━━━━━━━━━━━━━
【最重要原則（絶対遵守）】
━━━━━━━━━━━━━━━━━━━━━━
・判断主体は常に【施設ケアマネ本人】です
・あなた自身が結論・是非・適否を示してはいけません
・医学的・専門職的な断定判断は一切行わないでください
・改善策・指示・命令・助言を行ってはいけません
・「〜すべき」「〜が必要」「問題である」等の表現は禁止です

━━━━━━━━━━━━━━━━━━━━━━
【表現ルール（必ず守る）】
━━━━━━━━━━━━━━━━━━━━━━
以下のような【断定しない表現】を必ず用いてください。

・「〜と考えられる」
・「〜と整理できる」
・「〜がみられている」
・「〜がうかがわれる」
・「〜の可能性が示唆される」
・「〜に留意する必要があると考えられる」
・「〜を踏まえると」

※ 因果関係を固定する表現は禁止です  
※ 医学的診断名・進行・悪化などの断定は禁止です  

━━━━━━━━━━━━━━━━━━━━━━
【施設ケアマネジメントとして重視する視点】
━━━━━━━━━━━━━━━━━━━━━━
・多職種によるチームアプローチ
・施設生活の継続性
・安全配慮とリスク予防
・ケアプランとの整合性
・情報共有・経過整理の視点

※ 居宅ケアマネ向けの視点・用語・表現は一切使用しないでください

━━━━━━━━━━━━━━━━━━━━━━
【入力情報】
━━━━━━━━━━━━━━━━━━━━━━
■ 施設種別
${facilityType}

■ 利用者の基本情報
${basicInfo || "（記載なし）"}

■ モニタリング事実（観察・把握した事実）
${monitoringFacts}

■ 多職種からの情報
【介護職】
${multiDisciplinaryInfo?.care || "（記載なし）"}

【医療・看護職】
${multiDisciplinaryInfo?.nurse || "（記載なし）"}

【リハ職】
${multiDisciplinaryInfo?.rehab || "（記載なし）"}

■ ケアプラン上の目標
${planGoal || "（記載なし）"}

■ 今回、特に確認したいポイント
${checkPoint || "（記載なし）"}

━━━━━━━━━━━━━━━━━━━━━━
【出力指示（構成は固定）】
━━━━━━━━━━━━━━━━━━━━━━
以下の構成で、日本語で丁寧に出力してください。
「施設介護支援経過（第6表）」にそのまま転記できる文体を意識してください。
なお、出力の冒頭には、必ず次の一文を記載してください。

「✅ 以下、施設介護支援経過（第6表）記入等の参考にしてください」
※ 見出し記号（###、■など）は使用しないでください

① モニタリング事実の整理  
　・入力された事実を要約・整理する  
　・評価・解釈・原因分析は混ぜない  

② 多職種情報を踏まえた状況整理  
　・介護職／医療・看護職／リハ職の情報を並列に整理する  
　・職種間の優劣や正誤を示さない  

③ ケアプラン目標との整合性の整理  
　・達成・未達成の判断は行わない  
　・現在の状況との関係性のみを整理する  

④ 課題・留意点の整理（非断定）  
　・「課題」「留意点」という言葉は使用してよい  
　・結論や評価の確定は行わない  

⑤ 今後のモニタリングに向けた視点  
　・次回以降に確認していく視点を示す  
　・断定・指示にならない表現を用いる  

※ 箇条書きと文章を適切に併用してください  
※ 読み手が「施設ケアマネ本人」であることを常に意識してください  
`;

    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        {
          role: "system",
          content:
            "あなたは介護保険施設の計画担当介護支援専門員を支援する専門AIです。",
        },
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: 0.4,
    });

    const result = completion.choices[0].message.content;

    return res.status(200).json({ result });

  } catch (error) {
    console.error("facility eval error:", error);
    return res.status(500).json({
      error: "AI生成中にエラーが発生しました",
    });
  }
}
