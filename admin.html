<script>
const ADMIN_KEY = new URLSearchParams(location.search).get("key");

async function createUser() {
  const email = document.getElementById("email").value;
  const user_name = document.getElementById("user_name").value;
  const phone = document.getElementById("phone").value;
  const plan = document.getElementById("plan").value;
  const users = document.getElementById("users").value;

  if (!email || !user_name) {
    alert("メールアドレスと名前は必須です");
    return;
  }

  const res = await fetch("/api/admin", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": ADMIN_KEY
    },
    body: JSON.stringify({
      action: "create-user",
      email,
      user_name,
      phone,
      plan,
      users
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert("❌ エラー\n" + JSON.stringify(data, null, 2));
    return;
  }

  document.getElementById("createdPassword").value = data.temporaryPassword;
  document.getElementById("createdUserId").textContent = data.supabaseUserId;
  document.getElementById("createResult").style.display = "block";
}

function copyCreatedPassword() {
  const input = document.getElementById("createdPassword");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("コピーしました");
}

async function resetPassword() {
  const user_id = document.getElementById("reset_user_id").value;
  const email = document.getElementById("reset_email").value;

  if (!user_id || !email) {
    alert("User ID と email は必須です");
    return;
  }

  const res = await fetch("/api/admin", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": ADMIN_KEY
    },
    body: JSON.stringify({
      action: "reset-password",
      user_id,
      email
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(JSON.stringify(data));
    return;
  }

  document.getElementById("newPassword").value = data.temporaryPassword;
  document.getElementById("resetResult").style.display = "block";
}

function copyPassword() {
  const input = document.getElementById("newPassword");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("コピーしました");
}
</script>
