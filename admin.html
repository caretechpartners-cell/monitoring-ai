<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin User Create</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f6fa;
      padding: 30px;
    }

    .container {
      width: 420px;
      margin: 0 auto;
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    h2 {
      margin-bottom: 20px;
      font-size: 20px;
      text-align: center;
    }

    label {
      font-weight: bold;
      display: block;
      margin-top: 12px;
    }

    input,
    select {
      width: 100%;
      padding: 10px;
      margin-top: 6px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button {
      width: 100%;
      margin-top: 20px;
      padding: 12px;
      font-size: 16px;
      background: #0078ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>

<body>

<script>
  const ADMIN_KEY = new URLSearchParams(location.search).get("key");
</script>

<div class="container">

  <h2>ユーザー新規作成（Admin）</h2>

  <label>メールアドレス</label>
  <input id="email" type="email" placeholder="user@example.com" />

  <label>名前</label>
  <input id="user_name" type="text" placeholder="山田太郎" />

  <label>電話番号</label>
  <input id="phone" type="text" placeholder="090-xxxx-xxxx" />

  <label>プラン</label>
  <select id="plan">
    <option value="personal">個人プラン</option>
    <option value="corp">法人プラン</option>
  </select>

  <label>法人ユーザー数（個人は1でOK）</label>
  <input id="users" type="number" value="1" min="1" />

  <button onclick="createUser()">ユーザーを作成</button>

  <div id="createResult" style="display:none; margin-top:20px;">
    <div style="font-weight:bold;">一時パスワード</div>

    <input id="createdPassword" type="text" readonly />

    <button onclick="copyCreatedPassword()">コピー</button>

  </div>

  <hr style="margin:30px 0" />

  <h2>パスワード再発行（Admin）</h2>

  <label>メールアドレス</label>
  <input id="reset_email" type="email" placeholder="user@example.com" />

  <button onclick="resetPassword()">パスワードを再発行</button>

  <div id="resetResult" style="display:none; margin-top:20px;">
    <div style="font-weight:bold;">新しい一時パスワード</div>

    <input id="newPassword" type="text" readonly />

    <button onclick="copyPassword()">コピー</button>
  </div>

<hr style="margin:30px 0" />

<h2>購入済みプロダクト付与 / 解約（Admin）</h2>

<label>メールアドレス</label>
<input id="grant_email" type="email" placeholder="user@example.com" />

<label>プロダクト</label>
<select id="product_code">
  <option value="monitoring">モニタリングAI（居宅）</option>
  <option value="conference">議事録AI</option>
  <option value="facility_monitoring">施設モニタリング評価整理AI</option>
</select>

<label>ステータス</label>
<select id="subscription_status">
  <option value="active">active（有効）</option>
  <option value="canceled">canceled（解約）</option>
</select>

<button onclick="grantProduct()">状態を反映する</button>

<div id="grantResult" style="margin-top:15px;color:green;"></div>

</div>

<script>
  async function createUser() {
  const email = document.getElementById("email").value;
  const user_name = document.getElementById("user_name").value;
  const phone = document.getElementById("phone").value;
  const plan = document.getElementById("plan").value;
  const users = document.getElementById("users").value;

  if (!email || !user_name) {
    alert("メールアドレスと名前は必須です");
    return;
  }

  const res = await fetch("/api/user", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": ADMIN_KEY
    },
    body: JSON.stringify({
      action: "create-user",
      email,
      user_name,
      phone,
      plan,
      users
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert("❌ エラー\n" + JSON.stringify(data, null, 2));
    return;
  }

  document.getElementById("createdPassword").value = data.temporaryPassword;
  document.getElementById("createResult").style.display = "block";
}

function copyCreatedPassword() {
  const input = document.getElementById("createdPassword");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("コピーしました");
}

async function resetPassword() {
  const email = document.getElementById("reset_email").value;

    if (!email) {
    alert("email は必須です");
    return;
  }

  const res = await fetch("/api/user", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": ADMIN_KEY
    },
    body: JSON.stringify({
      action: "reset-password",
      email
    })
  });

  const data = await res.json();
  if (!res.ok) {
    alert(JSON.stringify(data));
    return;
  }

  document.getElementById("newPassword").value = data.temporaryPassword;
  document.getElementById("resetResult").style.display = "block";
}

function copyPassword() {
  const input = document.getElementById("newPassword");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("コピーしました");
}

async function grantProduct() {
  const email = document.getElementById("grant_email").value;
  const product_code = document.getElementById("product_code").value;
  const stripe_subscription_status =
    document.getElementById("subscription_status").value;

  if (!email || !product_code || !stripe_subscription_status) {
    alert("email / product / status は必須です");
    return;
  }

  const res = await fetch("/api/user", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "x-admin-key": ADMIN_KEY
    },
    body: JSON.stringify({
      action: "grant-product",
      email,
      product_code,
      stripe_subscription_status
    })
  });

  const data = await res.json();

  if (!res.ok) {
    alert("❌ エラー\n" + JSON.stringify(data, null, 2));
    return;
  }

  document.getElementById("grantResult").textContent =
    `✅ ${email} の ${product_code} を ${stripe_subscription_status} にしました`;
}

</script>

</body>
</html>
