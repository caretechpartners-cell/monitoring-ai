<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ã‚„ã•ã—ã„ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°è¦ç‚¹æ•´ç†AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap" rel="stylesheet">

  <style>
    body {
      margin: 0;
      font-family: "M PLUS Rounded 1c", sans-serif;
      background: #e9f6fb;
    }
    .container {
      max-width: 900px;
      margin: 40px auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #2a6f97;
      font-size: 32px;
      margin-bottom: 5px;
    }
    .powered {
      text-align: center;
      font-size: 16px;
      color: #777;
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 20px;
      margin-top: 22px;
      margin-bottom: 6px;
      color: #2a6f97;
    }
    textarea, input {
      width: 100%;
      font-size: 18px;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid #cfdfe8;
      box-sizing: border-box;
    }
    textarea {
      min-height: 140px;
    }
    .btn {
      width: 100%;
      height: 70px;
      font-size: 22px;
      border: none;
      border-radius: 16px;
      margin-top: 25px;
      cursor: pointer;
    }
    .generate-btn { background: #2a6f97; color: white; }
    .download-btn {
      background: #4caf50;
      color: white;
      margin-top: 15px;
      display: none;
    }
    .sample-btn {
      width: 100%;
      height: 55px;
      font-size: 18px;
      border: none;
      border-radius: 12px;
      margin-top: 15px;
      cursor: pointer;
      background: #f3a6b1;
      color: white;
    }

    .result-box {
      margin-top: 30px;
      font-size: 18px;
      background: #f7fbff;
      border-radius: 12px;
      padding: 20px;
      white-space: pre-wrap;
    }
    .copy-guide {
      margin-top: 15px;
      font-size: 18px;
      color: #2a6f97;
      font-weight: bold;
      display: none;
    }
    .memo-guide {
      margin-top: 20px;
      text-align: center;
      font-size: 18px;
      color: #2a6f97;
      font-weight: bold;
    }
    .limit {
      margin-top: 10px;
      text-align: center;
      font-size: 18px;
      color: #2a6f97;
      font-weight: bold;
    }

    .footer-links {
      margin-top: 60px;
      margin-bottom: 20px;
      text-align: center;
      font-size: 12px;
      color: #999;
    }
    .footer-links a {
      color: #777;
      text-decoration: none;
      margin: 0 6px;
    }
    .footer-links a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ã‚„ã•ã—ã„ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°è¦ç‚¹æ•´ç†AI</h1>
  <div class="powered">Powered by ã‚±ã‚¢ãƒ†ãƒƒã‚¯ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚º</div>
  <div class="limit" id="limitText"></div>

  <button class="sample-btn" onclick="fillSample()">ã‚µãƒ³ãƒ—ãƒ«å…¥åŠ›ã‚’å…¥ã‚Œã‚‹</button>

  <div class="memo-guide">â†“ æ–½è¨­å‘ã‘ã®é …ç›®ã”ã¨ã«å…¥åŠ›ã—ã¦ãã ã•ã„ â†“</div>

  <!-- â‘  åˆ©ç”¨è€…åŸºæœ¬æƒ…å ± -->
  <label>â–  åˆ©ç”¨è€…åŸºæœ¬æƒ…å ±</label>
  <textarea id="basicInfo" placeholder="æ°åï¼å¹´é½¢ï¼æ€§åˆ¥ï¼è¦ä»‹è­·åº¦ï¼å…¥æ‰€å½¢æ…‹ ãªã©"></textarea>

  <!-- â‘¡ ä¼šè­°åŸºæœ¬æƒ…å ± -->
  <label>â–  ä¼šè­°åŸºæœ¬æƒ…å ±ï¼ˆä¼šè­°ç¨®åˆ¥ãƒ»å‚åŠ è·ç¨®ãªã©ï¼‰</label>
  <textarea id="meetingInfo" placeholder="ä¼šè­°æ—¥ï¼ä¼šè­°ç¨®åˆ¥ï¼å‚åŠ è·ç¨®ï¼ˆä»‹è­·ãƒ»çœ‹è­·ãƒ»ãƒªãƒãƒ»ç›¸è«‡å“¡ãƒ»å®¶æ— ç­‰ï¼‰"></textarea>

  <!-- â‘¢ ç”Ÿæ´»çŠ¶æ³ãƒ»ADL -->
  <label>â–  ç¾åœ¨ã®ç”Ÿæ´»çŠ¶æ³ãƒ»ADLï¼ˆæ–½è¨­å†…ã§ã®æ§˜å­ï¼‰</label>
  <textarea id="adlInfo" placeholder="é£Ÿäº‹ã€æ’æ³„ã€ç§»å‹•ã€æ—¥ä¸­ãƒ»å¤œé–“ã®æ§˜å­ ãªã©"></textarea>

  <!-- â‘£ èª²é¡Œãƒ»ãƒªã‚¹ã‚¯ -->
  <label>â–  ç¾åœ¨ã®ä¸»ãªèª²é¡Œãƒ»ãƒªã‚¹ã‚¯</label>
  <textarea id="riskInfo" placeholder="è»¢å€’ã€åŒ»ç™‚ç®¡ç†ã€é›†å›£ç”Ÿæ´»ä¸Šã®èª²é¡Œ ãªã©"></textarea>

  <!-- â‘¤ å„è·ç¨®ã®æ„è¦‹ -->
  <label>â–  å„è·ç¨®ã‹ã‚‰ã®ä¸»ãªæ„è¦‹</label>
  <textarea id="staffOpinions" placeholder="ä»‹è­·è·ï¼çœ‹è­·è·ï¼ãƒªãƒè·ï¼ç›¸è«‡å“¡ ç­‰ã®æ„è¦‹"></textarea>

  <!-- â‘¥ ä»Šå¾Œã®æ”¯æ´æ–¹é‡ -->
  <label>â–  ä»Šå¾Œã®æ”¯æ´æ–¹é‡ãƒ»ã‚±ã‚¢ã®æ–¹å‘æ€§</label>
  <textarea id="futurePlan" placeholder="æ–½è¨­å†…ã§ã®ç”Ÿæ´»å®‰å®šãƒ»è‡ªç«‹æ”¯æ´ã®æ–¹é‡"></textarea>

  <!-- â‘¦ æœ¬äººãƒ»å®¶æ—æ„å‘ -->
  <label>â–  æœ¬äººãƒ»å®¶æ—ã®æ„å‘ï¼ç‰¹è¨˜äº‹é …</label>
  <textarea id="specialNotes" placeholder="æœ¬äººãƒ»å®¶æ—ã®å¸Œæœ›ã€ç‰¹è¨˜äº‹é …ãªã©"></textarea>

  <!-- è£å´ç”¨ï¼šæœ€çµ‚çš„ã«ã“ã“ã«çµ±åˆã•ã‚Œã‚‹ -->
  <textarea id="memoElem" style="display:none;"></textarea>

  <button class="btn generate-btn" onclick="buildFacilityMemoAndGenerate()">AIã§è­°äº‹éŒ²ã‚’ç”Ÿæˆã™ã‚‹</button>

  <div class="copy-guide" id="copyGuide">ã“ã®ã¾ã¾ã‚³ãƒ”ãƒ¼ã—ã¦è­°äº‹éŒ²ã«è²¼ã‚Šä»˜ã‘ã§ãã¾ã™ã€‚</div>

  <div id="result" class="result-box"></div>

  <button class="btn download-btn" id="xlsxBtn" onclick="exportXLSX()">
    ğŸ“Š Excelï¼ˆè­°äº‹éŒ²æ§˜å¼ï¼‰ã§å‡ºåŠ›
  </button>

  <!-- ä¼šå“¡æ¡ˆå†…ï¼ˆãã®ã¾ã¾æ®‹ã™ï¼‰ -->
  <div
    id="memberGuide"
    style="
      display:none;
      margin-top:20px;
      padding:18px;
      border-radius:12px;
      background:#f0f8ff;
      font-size:17px;
      line-height:1.8;
    "
  >
    ãƒ»ä¼šå“¡ç‰ˆã§ã¯ã€å›æ•°åˆ¶é™ãªãè­°äº‹éŒ²ã‚’ä½œæˆã§ãã¾ã™ã€‚<br>
    ãƒ»Excelæ§˜å¼ï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°éŒ²ï¼‰ã§ãã®ã¾ã¾å‡ºåŠ›å¯èƒ½ã§ã™ã€‚<br>
    ãƒ»å®Ÿåœ°æŒ‡å°ãƒ»ç›£æŸ»ã‚’æƒ³å®šã—ãŸæ§‹æˆã§ã™ã€‚<br><br>

    <a href="lp-conf.html" style="
      display:block;
      text-align:center;
      font-weight:bold;
      color:#2a6f97;
      text-decoration:none;
    ">
      ä¼šå“¡ç‰ˆã®è©³ç´°ã‚’è¦‹ã‚‹
    </a>
  </div>

  <div class="footer-links">
    <a href="privacy.html">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ï½œ
    <a href="terms.html">åˆ©ç”¨è¦ç´„</a>ï½œ
    <a href="tokusho.html">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>
  </div>
</div>

<script>
/* ==========================
   ç„¡æ–™ãƒˆãƒ©ã‚¤ã‚¢ãƒ«å›æ•°ç®¡ç†ï¼ˆå®Œå…¨å…±é€šï¼‰
========================== */
const LIMIT = 3;

function initLimit() {
  if (!localStorage.getItem("conf_remain")) {
    localStorage.setItem("conf_remain", LIMIT);
  }
  updateLimit();
}

function updateLimit() {
  const remain = Number(localStorage.getItem("conf_remain"));
  const limitText = document.getElementById("limitText");

  if (remain > 0) {
    limitText.textContent = `ğŸŒ· ç„¡æ–™ã§ã‚ã¨ã€Œ${remain}å›ã€ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™`;
  } else {
    limitText.textContent = "ç„¡æ–™ä½œæˆåˆ†ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚";
  }
}

initLimit();

function fillSample() {
  document.getElementById("basicInfo").value =
    "å±±ç”°èŠ±å­ã€€85æ­³ã€€å¥³æ€§ã€€è¦ä»‹è­·4\n" +
    "ç‰¹åˆ¥é¤Šè­·è€äººãƒ›ãƒ¼ãƒ å…¥æ‰€ä¸­ï¼ˆå…¥æ‰€3å¹´ç›®ï¼‰";

  document.getElementById("meetingInfo").value =
    "2026/1/15 10:00-11:00\n" +
    "å®šæœŸã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°ï¼ˆæ–½è¨­å†…ï¼‰\n" +
    "å‚åŠ ï¼šä»‹è­·è·ã€çœ‹è­·å¸«ã€æ©Ÿèƒ½è¨“ç·´æŒ‡å°å“¡ã€ç”Ÿæ´»ç›¸è«‡å“¡ã€æ–½è¨­ã‚±ã‚¢ãƒãƒã€å®¶æ—ï¼ˆé•·å¥³ï¼‰";

  document.getElementById("adlInfo").value =
    "é£Ÿäº‹ï¼šå…¨ä»‹åŠ©ã€ã‚€ã›è¾¼ã¿æ™‚ã€…ã‚ã‚Š\n" +
    "ç§»å‹•ï¼šè»Šæ¤…å­è‡ªèµ°ä¸€éƒ¨å¯èƒ½ã€ç«‹ã¡ä¸ŠãŒã‚Šä¸å®‰å®š\n" +
    "æ’æ³„ï¼šã‚ªãƒ ãƒ„ä½¿ç”¨ã€ãƒˆã‚¤ãƒ¬èª˜å°ä¸€éƒ¨å®Ÿæ–½\n" +
    "æ—¥ä¸­ï¼šå±…å®¤å†…ã§éã”ã™ã“ã¨å¤šã„\n" +
    "å¤œé–“ï¼šè¦šé†’ã‚ã‚Šã€ãƒŠãƒ¼ã‚¹ã‚³ãƒ¼ãƒ«é »å›";

  document.getElementById("riskInfo").value =
    "å¤œé–“ãƒ™ãƒƒãƒ‰ã‹ã‚‰ã®ç«‹ã¡ä¸ŠãŒã‚Šã«ã‚ˆã‚‹è»¢å€’ãƒªã‚¹ã‚¯é«˜ã„\n" +
    "åš¥ä¸‹æ©Ÿèƒ½ä½ä¸‹ã«ã‚ˆã‚‹èª¤åš¥ãƒªã‚¹ã‚¯ã‚ã‚Š\n" +
    "èªçŸ¥ç—‡ç—‡çŠ¶ã«ã‚ˆã‚Šä¸å®‰å¼·ãã€è¡Œå‹•ä¸å®‰å®šãªå ´é¢ã‚ã‚Š";

  document.getElementById("staffOpinions").value =
    "ä»‹è­·è·ï¼šå¤œé–“ã®é›¢åºŠãŒå¤šãã€è¦‹å®ˆã‚Šå¼·åŒ–ãŒå¿…è¦\n" +
    "çœ‹è­·å¸«ï¼šåš¥ä¸‹çŠ¶æ…‹ã«æ³¨æ„ã—ã€é£Ÿå½¢æ…‹ã®å†è©•ä¾¡ã‚’ææ¡ˆ\n" +
    "æ©Ÿèƒ½è¨“ç·´ï¼šä¸‹è‚¢ç­‹åŠ›ä½ä¸‹ã‚ã‚Šã€ç°¡æ˜“è¨“ç·´ç¶™ç¶šãŒæœ›ã¾ã—ã„\n" +
    "ç›¸è«‡å“¡ï¼šå®¶æ—ã¨ã®æƒ…å ±å…±æœ‰ã‚’å¯†ã«ã™ã‚‹å¿…è¦ã‚ã‚Š";

  document.getElementById("futurePlan").value =
    "å¤œé–“ã‚»ãƒ³ã‚µãƒ¼ãƒãƒƒãƒˆã®å°å…¥ã‚’æ¤œè¨\n" +
    "é£Ÿå½¢æ…‹ã®è¦‹ç›´ã—ã‚’å¤šè·ç¨®ã§æ¤œè¨\n" +
    "æ—¥ä¸­ã®é›¢åºŠæ™‚é–“ã‚’å¢—ã‚„ã—ç”Ÿæ´»ãƒªã‚ºãƒ ã‚’æ•´ãˆã‚‹";

  document.getElementById("specialNotes").value =
    "æœ¬äººï¼šã€è¿·æƒ‘ã‚’ã‹ã‘ãŸããªã„ã€ã¨ä¸å®‰ã‚’è¨´ãˆã‚‹\n" +
    "å®¶æ—ï¼šè»¢å€’ã¨èª¤åš¥ã‚’ç‰¹ã«å¿ƒé…ã—ã¦ã„ã‚‹\n" +
    "æ¬¡å›ä¼šè­°ã¾ã§äº‹æ•…çŠ¶æ³ã‚’é‡ç‚¹çš„ã«å…±æœ‰ã™ã‚‹";
}

/* ==========================
   æ–½è¨­ç‰ˆï¼šé …ç›®çµ±åˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆã“ã“ãŒå”¯ä¸€ã®å·®åˆ†æ ¸å¿ƒï¼‰
========================== */
function buildFacilityMemo() {
  const memo =
    "ã€åˆ©ç”¨è€…åŸºæœ¬æƒ…å ±ã€‘\n" + basicInfo.value + "\n\n" +
    "ã€ä¼šè­°åŸºæœ¬æƒ…å ±ã€‘\n" + meetingInfo.value + "\n\n" +
    "ã€ç”Ÿæ´»çŠ¶æ³ãƒ»ADLã€‘\n" + adlInfo.value + "\n\n" +
    "ã€èª²é¡Œãƒ»ãƒªã‚¹ã‚¯ã€‘\n" + riskInfo.value + "\n\n" +
    "ã€å„è·ç¨®ã®æ„è¦‹ã€‘\n" + staffOpinions.value + "\n\n" +
    "ã€ä»Šå¾Œã®æ”¯æ´æ–¹é‡ã€‘\n" + futurePlan.value + "\n\n" +
    "ã€æœ¬äººãƒ»å®¶æ—æ„å‘ãƒ»ç‰¹è¨˜äº‹é …ã€‘\n" + specialNotes.value;

  memoElem.value = memo;
}

function buildFacilityMemoAndGenerate() {
  buildFacilityMemo();
  generate(); // æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãã®ã¾ã¾å‘¼ã¶
}

/* ==========================
   é€²æ—è¡¨ç¤ºãƒ»ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå±…å®…ç‰ˆã¨å®Œå…¨å…±é€šï¼‰
========================== */
let progressTimer = null;
let progressValue = 0;

function startProgress() {
  progressValue = 0;
  result.textContent = "ç”Ÿæˆä¸­â€¦ 0%";

  progressTimer = setInterval(() => {
    if (progressValue < 98) {
      const add =
        progressValue < 70 ? 4 :
        progressValue < 90 ? 2 : 1;

      progressValue += add;
      if (progressValue > 98) progressValue = 98;

      if (progressValue >= 90) {
        result.textContent = "æ–‡ç« ã‚’æ•´ãˆã¦ã„ã¾ã™â€¦";
      } else {
        result.textContent = `ç”Ÿæˆä¸­â€¦ ${progressValue}%`;
      }
    }
  }, 300);
}

function finishProgress() {
  if (progressTimer) {
    clearInterval(progressTimer);
    progressTimer = null;
  }
  result.textContent = "ç”Ÿæˆå®Œäº†ï¼ˆ100%ï¼‰";
}

async function generate() {
  let remain = Number(localStorage.getItem("conf_remain"));

  if (remain <= 0) {
    alert(
      "ã“ã“ã¾ã§ãŠè©¦ã—ã„ãŸã ãã€ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ ğŸ˜Š\n\n" +
      "ã“ã®ã‚ã¨ã‚‚è­°äº‹éŒ²AIã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã®ã§ã€\n" +
      "ã‚ˆã‚ã—ã‘ã‚Œã°ä¼šå“¡ç‰ˆã®ã”æ¡ˆå†…ã‚’ã”è¦§ãã ã•ã„ã€‚"
    );

    setTimeout(() => {
      location.href = "lp-conf.html";
    }, 1200);
    return;
  }

  try {
    const memo = memoElem.value;

    copyGuide.style.display = "none";
    xlsxBtn.style.display = "none";

    startProgress();

    const res = await fetch("/api/generate-conf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ memo })
    });

    if (!res.ok) {
      const text = await res.text();
      throw new Error(`APIã‚¨ãƒ©ãƒ¼: ${res.status} ${text}`);
    }

    const data = await res.json();

    if (data.result) {
      finishProgress();

      setTimeout(() => {
        result.textContent = data.result;
      }, 300);

      document.getElementById("memberGuide").style.display = "block";

      remain--;
      localStorage.setItem("conf_remain", remain);
      updateLimit();

      copyGuide.style.display = "block";
      xlsxBtn.style.display = "block";
    } else {
      result.textContent = data.error || "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ";
    }

  } catch (err) {
    console.error(err);
    if (progressTimer) clearInterval(progressTimer);
    progressValue = 0;
    result.textContent = "è­°äº‹éŒ²ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
  }
}

/* ==========================
   Excelå‡ºåŠ›ï¼ˆå®Œå…¨å…±é€šï¼‰
========================== */
function exportXLSX() {
  fetch("/api/export-excel", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      memo: memoElem.value,
      aiResult: result.textContent
    })
  })
  .then(res => {
    if (!res.ok) throw new Error("Excelç”Ÿæˆã‚¨ãƒ©ãƒ¼");
    return res.blob();
  })
  .then(blob => {
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    let userName = "åˆ©ç”¨è€…";

    const explicitMatch = memoElem.value.match(/åˆ©ç”¨è€…[:ï¼š]\s*([^\nã€€]+)/);
    if (explicitMatch) {
      userName = explicitMatch[1].trim();
    }

    const dateMatch = memoElem.value.match(/(\d{1,2})\/(\d{1,2})/);
    const date = dateMatch
      ? new Date().getFullYear() + "-" +
        dateMatch[1].padStart(2, "0") + "-" +
        dateMatch[2].padStart(2, "0")
      : new Date().toISOString().split("T")[0];

    a.download = userName + "_" + date + ".xlsx";
    a.href = url;
    a.click();
    URL.revokeObjectURL(url);
  })
  .catch(err => {
    alert("Excelã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    console.error(err);
  });
}

/* ==========================
   ç®¡ç†è€…éš ã—ã‚³ãƒãƒ³ãƒ‰ï¼ˆå®Œå…¨å…±é€šï¼‰
========================== */
document.addEventListener("keydown", function(e) {
  if (e.ctrlKey && e.shiftKey && e.key === "R") {
    const pass = prompt("ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

    if (pass === "admin123") {
      localStorage.setItem("conf_remain", 3);
      alert("è­°äº‹éŒ²AIã®ç„¡æ–™å›æ•°ã‚’3å›ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
      location.reload();
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  }
});
</script>

</body>
</html>
