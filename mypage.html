<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒã‚¤ãƒšãƒ¼ã‚¸ï½œã‚„ã•ã—ã„ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link
    href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&display=swap"
    rel="stylesheet"
  >

  <style>
    body {
      margin: 0;
      font-family: "M PLUS Rounded 1c", sans-serif;
      background: #e9f6fb;
    }

    .container {
      max-width: 800px;
      margin: 60px auto;
      background: #ffffff;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    h1 {
      color: #2a6f97;
      font-size: 30px;
      margin-bottom: 25px;
    }

    .btn {
      width: 100%;
      height: 70px;
      font-size: 22px;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      margin-top: 20px;
    }

    .status-btn {
      background: #2a6f97;
      color: white;
    }

    .plan-btn {
      background: #f3a6b1;
      color: white;
    }

    .portal-btn {
      background: #b0b0b0; /* ã‚°ãƒ¬ãƒ¼ */
      color: #333;
    }

    .portal-btn:hover {
      opacity: 0.9;
    }

    .back-fixed {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #cccccc;
      color: #333;
      padding: 12px 18px;
      border-radius: 12px;
      font-size: 16px;
      border: none;
      cursor: pointer;
      z-index: 9999;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>

<body>
  <button
    class="back-fixed"
    onclick="location.href='app.html'"
  >
    â† ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹
  </button>

  <div class="container">
    <h1>ãƒã‚¤ãƒšãƒ¼ã‚¸</h1>

    <button class="btn status-btn" onclick="goStatus()">
      åˆ©ç”¨çŠ¶æ³ã®ç¢ºèª
    </button>

    <button class="btn plan-btn" onclick="goPlan()">
      åˆ©ç”¨ãƒ—ãƒ©ãƒ³ã®å¤‰æ›´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã¸ï¼‰
    </button>

   <button class="btn portal-btn" onclick="openPortal('monitoring')">
  ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°AIã®è§£ç´„
</button>

<button class="btn portal-btn" onclick="openPortal('conference')"style="display:none;">
  ã‚µãƒ¼ãƒ“ã‚¹æ‹…å½“è€…ä¼šè­°éŒ²AIã®è§£ç´„
</button>



    <div id="portalErr" style="color:red; margin-top:12px;"></div>
  </div>

  <script>
    // ğŸ”’ app.html ã‹ã‚‰ã®é·ç§»ãƒã‚§ãƒƒã‚¯
    if (!sessionStorage.getItem("fromApp")) {
      location.href = "login.html";
    }

    function goStatus() {
      location.href = "status.html";
    }

    function goPlan() {
      location.href = "form-corp.html";
    }

const RE_PURCHASE_LINKS = {
  monitoring: "https://buy.stripe.com/3cIeV65wve8X4ly40XeME00",
  conference: "https://buy.stripe.com/cNi3cocYXc0P8BO0OLeME05",
};


    // ================================
    // ğŸ’³ Stripe Customer Portal ã‚’é–‹ã
    // ================================
    async function openPortal(product_code) {
      const user_id = localStorage.getItem("auth_user_id");
      const token = localStorage.getItem("login_session_token");
      const errEl = document.getElementById("portalErr");

      errEl.textContent = "";

      try {
        // â‘  ã‚»ãƒƒã‚·ãƒ§ãƒ³æœ‰åŠ¹ãƒã‚§ãƒƒã‚¯
        const guardRes = await fetch("/api/auth-guard", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ user_id, token }),
        });

        const guardData = await guardRes.json();

        if (!guardData.valid) {
          localStorage.removeItem("auth_user_id");
          localStorage.removeItem("login_session_token");
          location.href = "login.html";
          return;
        }

        // â‘¡ Portal URL ç™ºè¡Œ
        const res = await fetch("/api/user", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
  user_id,
  action: "portal",
  product_code, // â† ã“ã‚Œã‚’è¿½åŠ 
}),

        });

        const data = await res.json();

if (!data.success || !data.url) {
  if (data.reason === "stripe_customer_not_found") {
    errEl.textContent =
      "Stripeã®é¡§å®¢æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ç®¡ç†è€…ã«ã”é€£çµ¡ãã ã•ã„ã€‚";
    return;
  }

  const link = RE_PURCHASE_LINKS[product_code];

  errEl.innerHTML = `
    æ—¢ã«è§£ç´„æ¸ˆã¿ã§ã™ã€‚<br>
    ${
      link
        ? `<a href="${link}" target="_blank" style="color:#2a6f97; font-weight:bold;">
             â–¶ å†å¥‘ç´„ã¯ã“ã¡ã‚‰
           </a>`
        : "å†å¥‘ç´„ãƒªãƒ³ã‚¯ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™ã€‚"
    }
  `;
  return;
}

        // â‘¢ Stripe Customer Portal ã‚’é–‹ãï¼ˆåˆ¥ã‚¿ãƒ–ï¼‰
        window.open(data.url, "_blank");
      } catch (e) {
        console.error(e);
        errEl.textContent = "é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
      }
    }
  </script>
</body>
</html>
